;/*FB_PKG_DELIM*/

__d("MUFILiveCommentActivity.react",["cx","CSS","MCache","MLegacyDataStore","MParent","MUFICommentTypingIndicator.react","MUFINewCommentsSocialPill.react","MUFIReactionsUtils","MUFITypingIndicatorPill.react","MViewport","Stratcom","SubscriptionsHandler","react"],(function(a,b,c,d,e,f,g,h){"use strict";var i=d("react"),j=40,k=15,l="_mufiseencomments";a=function(a){babelHelpers.inheritsLoose(b,a);function b(b,c){var e;e=a.call(this,b,c)||this;e.onScroll=function(a){e.state.unseenCommentIDs.length&&e.isCommentVisible(e.state.unseenCommentIDs[0])?(e.clearScrollListener(),e.highlightComments(e.state.unseenCommentIDs),e.setState({seenCommentIDs:e.props.comments,unseenCommentIDs:[],showPill:!1})):e.props.isAnyLiveTyping&&e.isTypingIndicatorCellVisible()&&(e.clearScrollListener(),e.setState({showPill:!1}))};e.onNewCommentPillClick=function(a){a.preventDefault();e.clearScrollListener();e.highlightComments(e.state.unseenCommentIDs);a=e.getCommentElement(e.state.unseenCommentIDs[0]);a&&e.scrollToNode(a);e.setState({seenCommentIDs:e.props.comments,unseenCommentIDs:[],showPill:!1})};e.onTypingIndicatorPillClick=function(a){a.preventDefault(),e.clearScrollListener(),e.typingIndicatorElement&&e.scrollToNode(e.typingIndicatorElement),e.setState({showPill:!1})};e.cacheID=b.feedbackTargetID+l;var f={};c=d("MCache").getItem(e.cacheID);Array.isArray(c)&&c.forEach(function(a){f[a]=!0});var g=[],h=[];b.comments.forEach(function(a){a in f?g.push(a):h.push(a)});e.state={seenCommentIDs:g,unseenCommentIDs:h,showPill:!1};return e}var e=b.prototype;e.UNSAFE_componentWillReceiveProps=function(a){var b={};this.state.seenCommentIDs.forEach(function(a){b[a]=!0});var c=a.comments.filter(function(a){return!(a in b)});this.setupScrollListenerAndPillState(a.comments,c)};e.componentDidMount=function(){this.setupScrollListenerAndPillState(this.props.comments,this.state.unseenCommentIDs)};e.setupScrollListenerAndPillState=function(a,b){this.scrollArea=d("MParent").bySigil(this.refs.root,"scroll-area");this.clearScrollListener();var c=!1,e=this.state.seenCommentIDs;b.length?this.isCommentVisible(b[0])?(this.highlightComments(b),e=a,b=[]):(c=!0,this.startScrollListener()):this.props.isAnyLiveTyping&&!this.isTypingIndicatorCellVisible()&&(c=!0,this.startScrollListener());this.setState({showPill:c,seenCommentIDs:e,unseenCommentIDs:b})};e.componentWillUnmount=function(){this.clearScrollListener(),d("MCache").setItem(this.cacheID,this.state.seenCommentIDs.slice())};e.clearScrollListener=function(){this.scrollHandler&&this.scrollHandler.release(),this.scrollHandler=null};e.startScrollListener=function(){this.scrollHandler||(this.scrollHandler=new(c("SubscriptionsHandler"))(),this.scrollHandler.addSubscriptions(c("Stratcom").listen(this.scrollArea?"MScrollArea:scroll":"scroll",null,this.onScroll.bind(this))))};e.isCommentVisible=function(a){a=this.getCommentElement(a);return this.isElementAboveViewportBottom(a,j)};e.isTypingIndicatorCellVisible=function(){return this.isElementAboveViewportBottom(this.typingIndicatorElement,k)};e.isElementAboveViewportBottom=function(a,b){if(!a)return!1;a=this.getElementTop(a);var c=this.scrollArea?this.scrollArea.offsetHeight:d("MViewport").getScreenHeight();return a+b<c};e.getElementTop=function(a){a=a.getBoundingClientRect().top;this.scrollArea&&(a-=this.scrollArea.getBoundingClientRect().top);return a};e.getCommentElement=function(a){a=d("MUFIReactionsUtils").maybeConvertTokenToFBID(a);return a?document.getElementById(a):null};e.scrollToNode=function(a){if(this.scrollArea){var b=d("MLegacyDataStore").get(this.scrollArea).scrollArea;b.scrollTo(0,Math.min(this.getElementTop(a),b.getMaxScrollTop()))}else a.scrollIntoView()};e.highlightComments=function(a){var b=this;a.forEach(function(a){a=b.getCommentElement(a);a&&(c("CSS").addClass(a,"_1vcf"),c("CSS").addClass(a,"_625u"))})};e.renderPill=function(){if(this.props.disablePill)return null;var a=null;this.state.unseenCommentIDs.length?a=i.jsx(c("MUFINewCommentsSocialPill.react"),{commentIDs:this.state.unseenCommentIDs,onClick:this.onNewCommentPillClick.bind(this)}):this.props.isAnyLiveTyping&&(a=i.jsx(c("MUFITypingIndicatorPill.react"),{onClick:this.onTypingIndicatorPillClick.bind(this)}));return!a?null:i.jsx("div",{className:"_5t1e","data-sigil":"mufi-pill-overlay",children:a},"pill")};e.renderTypingIndicator=function(){var a=this;return i.jsx("div",{ref:function(b){return a.typingIndicatorElement=b},children:i.jsx(c("MUFICommentTypingIndicator.react"),{})})};e.render=function(){return i.jsxs("div",{ref:"root",children:[this.props.isAnyLiveTyping?this.renderTypingIndicator():null,this.state.showPill?this.renderPill():null]})};return b}(i.Component);g["default"]=a}),98);